import './style.css';

interface MoodRating {
  value: number;
  emoji: string;
  label: string;
}

interface DiaryTemplate {
  id: string;
  name: string;
  title: string;
  content: string;
  type: 'preset' | 'custom';
  createdAt: string;
}

interface DiaryEntry {
  id: string;
  title: string;
  content: string;
  date: string;
  mood?: number;
  images?: string[];
  attachments?: FileAttachment[];
}

interface FileAttachment {
  id: string;
  name: string;
  type: string;
  size: number;
  data: string;
}

class DiaryApp {
  private entries: DiaryEntry[] = [];
  private filteredEntries: DiaryEntry[] = [];
  private form: HTMLFormElement;
  private titleInput: HTMLInputElement;
  private contentInput: HTMLTextAreaElement;
  private diaryList: HTMLElement;
  private editingId: string | undefined = undefined;
  private searchInput: HTMLInputElement;
  private dateFromInput: HTMLInputElement;
  private dateToInput: HTMLInputElement;
  private clearSearchButton: HTMLButtonElement;
  private searchResultsCount: HTMLElement;
  private currentSearchTerm: string = '';
  private moodButtons: HTMLElement[] = [];
  private selectedMood: number | undefined = undefined;
  private selectedImages: string[] = [];
  private selectedAttachments: FileAttachment[] = [];
  private imageInput: HTMLInputElement;
  private fileInput: HTMLInputElement;
  // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÈñ¢ÈÄ£
  private templates: DiaryTemplate[] = [];
  private templateSelector: HTMLSelectElement;
  private saveTemplateButton: HTMLButtonElement;
  private manageTemplatesButton: HTMLButtonElement;

  private readonly moodRatings: MoodRating[] = [
    { value: 1, emoji: 'üò¢', label: '„Å®„Å¶„ÇÇÊÇ≤„Åó„ÅÑ' },
    { value: 2, emoji: 'üòê', label: 'ÊÇ≤„Åó„ÅÑ' },
    { value: 3, emoji: 'üòä', label: 'ÊôÆÈÄö' },
    { value: 4, emoji: 'üòÑ', label: 'Â¨â„Åó„ÅÑ' },
    { value: 5, emoji: 'üòç', label: '„Å®„Å¶„ÇÇÂ¨â„Åó„ÅÑ' },
  ];
  private readonly presetTemplates: DiaryTemplate[] = [
    {
      id: 'daily-reflection',
      name: 'Êó•„ÄÖ„ÅÆÊåØ„ÇäËøî„Çä',
      title: '‰ªäÊó•„ÅÆÊåØ„ÇäËøî„Çä',
      content:
        '‰ªäÊó•„ÅØ‰Ωï„Çí„Åó„Åæ„Åó„Åü„ÅãÔºö\n\nÂ≠¶„Çì„Å†„Åì„Å®Ôºö\n\nÊÑüË¨ù„Åó„Åü„ÅÑ„Åì„Å®Ôºö\n\nÊòéÊó•„Å´Âêë„Åë„Å¶Ôºö',
      type: 'preset',
      createdAt: new Date().toISOString(),
    },
    {
      id: 'gratitude-diary',
      name: 'ÊÑüË¨ùÊó•Ë®ò',
      title: '‰ªäÊó•„ÅÆÊÑüË¨ù',
      content: 'ÊÑüË¨ù„Åó„Å¶„ÅÑ„Çã„Åì„Å®Ôºà3„Å§ÔºâÔºö\n1. \n2. \n3. \n\n„Åù„ÅÆÁêÜÁî±Ôºö',
      type: 'preset',
      createdAt: new Date().toISOString(),
    },
    {
      id: 'work-log',
      name: 'Ê•≠ÂãôÊó•Â†±',
      title: 'Ê•≠ÂãôÊó•Â†± - {{DATE}}',
      content:
        '‰ªäÊó•„ÅÆ‰ΩúÊ•≠ÂÜÖÂÆπÔºö\n\nÊàêÊûú„ÉªÈÅîÊàê„Åó„Åü„Åì„Å®Ôºö\n\nË™≤È°å„ÉªÂïèÈ°åÁÇπÔºö\n\nÊòéÊó•„ÅÆ‰∫àÂÆöÔºö',
      type: 'preset',
      createdAt: new Date().toISOString(),
    },
    {
      id: 'health-log',
      name: 'ÂÅ•Â∫∑Ë®òÈå≤',
      title: 'ÂÅ•Â∫∑Ë®òÈå≤',
      content: '‰ΩìË™øÔºö\n\nÈÅãÂãïÔºö\n\nÈ£ü‰∫ãÔºö\n\nÁù°Áú†Ôºö\n\n„Åù„ÅÆ‰ªñ„É°„É¢Ôºö',
      type: 'preset',
      createdAt: new Date().toISOString(),
    },
    {
      id: 'learning-log',
      name: 'Â≠¶ÁøíË®òÈå≤',
      title: 'Â≠¶ÁøíË®òÈå≤',
      content:
        'Â≠¶ÁøíÂÜÖÂÆπÔºö\n\nÊñ∞„Åó„ÅèË¶ö„Åà„Åü„Åì„Å®Ôºö\n\nÁêÜËß£Â∫¶Ôºà1-5ÔºâÔºö\n\nÊ¨°Âõû„ÅÆÁõÆÊ®ôÔºö',
      type: 'preset',
      createdAt: new Date().toISOString(),
    },
  ];

  constructor() {
    this.form = document.getElementById('diary-form') as HTMLFormElement;
    this.titleInput = document.getElementById(
      'diary-title'
    ) as HTMLInputElement;
    this.contentInput = document.getElementById(
      'diary-content'
    ) as HTMLTextAreaElement;
    this.diaryList = document.getElementById('diary-list') as HTMLElement;
    this.searchInput = document.getElementById(
      'search-input'
    ) as HTMLInputElement;
    this.dateFromInput = document.getElementById(
      'date-from'
    ) as HTMLInputElement;
    this.dateToInput = document.getElementById('date-to') as HTMLInputElement;
    this.clearSearchButton = document.getElementById(
      'clear-search'
    ) as HTMLButtonElement;
    this.searchResultsCount = document.getElementById(
      'search-results-count'
    ) as HTMLElement;
    this.imageInput = document.getElementById(
      'image-input'
    ) as HTMLInputElement;
    this.fileInput = document.getElementById('file-input') as HTMLInputElement;

    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË¶ÅÁ¥†„ÅÆÂàùÊúüÂåñ
    this.templateSelector = document.getElementById(
      'template-selector'
    ) as HTMLSelectElement;
    this.saveTemplateButton = document.getElementById(
      'save-template'
    ) as HTMLButtonElement;
    this.manageTemplatesButton = document.getElementById(
      'manage-templates'
    ) as HTMLButtonElement;

    this.loadEntries();
    this.loadTemplates();
    this.bindEvents();
    this.initializeMoodSelector();
    this.initializeFileInputs();
    this.initializeTemplateFeatures();
    this.initializeExportFeatures();
    this.updateMoodFeatures();
    this.applyFilters();
  }

  private bindEvents() {
    this.form.addEventListener('submit', e => {
      e.preventDefault();
      if (this.editingId) {
        this.updateEntry();
      } else {
        this.addEntry();
      }
    });

    this.searchInput.addEventListener('input', () => {
      this.applyFilters();
    });

    this.dateFromInput.addEventListener('change', () => {
      this.applyFilters();
    });

    this.dateToInput.addEventListener('change', () => {
      this.applyFilters();
    });

    this.clearSearchButton.addEventListener('click', () => {
      this.clearFilters();
    });
  }

  private addEntry() {
    const title = this.titleInput.value.trim();
    const content = this.contentInput.value.trim();

    if (!(title && content)) {
      alert('„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }

    const entry: DiaryEntry = {
      id: Date.now().toString(),
      title,
      content,
      date: new Date().toLocaleDateString('ja-JP', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        weekday: 'long',
      }),
      mood: this.selectedMood,
      images: [...this.selectedImages],
      attachments: [...this.selectedAttachments],
    };

    this.entries.unshift(entry);
    this.saveEntries();
    this.updateMoodFeatures();
    this.applyFilters();
    this.clearForm();
  }

  private deleteEntry(id: string) {
    if (confirm('„Åì„ÅÆÊó•Ë®ò„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
      this.entries = this.entries.filter(entry => entry.id !== id);
      this.saveEntries();
      this.updateMoodFeatures();
      this.applyFilters();
    }
  }

  private editEntry(id: string) {
    const entry = this.entries.find(entry => entry.id === id);
    if (entry) {
      this.titleInput.value = entry.title;
      this.contentInput.value = entry.content;
      this.selectedMood = entry.mood;
      this.selectedImages = entry.images ? [...entry.images] : [];
      this.selectedAttachments = entry.attachments
        ? [...entry.attachments]
        : [];
      this.updateMoodSelection();
      this.updateFileDisplay();
      this.editingId = id;
      this.updateFormForEditing();
      window.scrollTo(0, 0);
    }
  }

  private updateEntry() {
    const title = this.titleInput.value.trim();
    const content = this.contentInput.value.trim();

    if (!title || !content) {
      alert('„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
      return;
    }

    const entryIndex = this.entries.findIndex(
      entry => entry.id === this.editingId
    );
    if (entryIndex !== -1) {
      this.entries[entryIndex] = {
        ...this.entries[entryIndex],
        title,
        content,
        mood: this.selectedMood,
        images: [...this.selectedImages],
        attachments: [...this.selectedAttachments],
      };
      this.saveEntries();
      this.updateMoodFeatures();
      this.applyFilters();
      this.cancelEdit();
    }
  }

  private cancelEdit() {
    this.editingId = undefined;
    this.clearForm();
    this.updateFormForEditing();
  }

  private updateFormForEditing() {
    const submitButton = this.form.querySelector(
      'button[type="submit"]'
    ) as HTMLButtonElement;
    const formTitle = document.querySelector('h2') as HTMLElement;

    if (this.editingId) {
      submitButton.textContent = 'Êõ¥Êñ∞„Åô„Çã';
      submitButton.className =
        'w-full bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600 transition duration-200';

      formTitle.textContent = 'Êó•Ë®ò„ÇíÁ∑®ÈõÜ ';
      const cancelButton = document.createElement('button');
      cancelButton.id = 'cancel-edit';
      cancelButton.textContent = '„Ç≠„É£„É≥„Çª„É´';
      cancelButton.className =
        'ml-2 text-sm bg-gray-500 text-white px-2 py-1 rounded hover:bg-gray-600';
      cancelButton.addEventListener('click', () => this.cancelEdit());

      formTitle.appendChild(cancelButton);
    } else {
      submitButton.textContent = '‰øùÂ≠ò„Åô„Çã';
      submitButton.className =
        'w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 transition duration-200';
      formTitle.textContent = 'Êñ∞„Åó„ÅÑÊó•Ë®ò„ÇíÊõ∏„Åè';
    }
  }

  private clearForm() {
    this.titleInput.value = '';
    this.contentInput.value = '';
    this.selectedMood = undefined;
    this.selectedImages = [];
    this.selectedAttachments = [];
    this.updateMoodSelection();
    this.updateFileDisplay();
  }

  private saveEntries() {
    localStorage.setItem('diary-entries', JSON.stringify(this.entries));
  }

  private loadEntries() {
    const stored = localStorage.getItem('diary-entries');
    if (stored) {
      try {
        this.entries = JSON.parse(stored);
      } catch (error) {
        console.error('Error parsing diary entries:', error);
      }
    }
  }

  private applyFilters() {
    const searchTerm = this.searchInput.value.toLowerCase().trim();
    const dateFrom = this.dateFromInput.value;
    const dateTo = this.dateToInput.value;

    this.currentSearchTerm = searchTerm;

    this.filteredEntries = this.entries.filter(entry => {
      const matchesSearch =
        !searchTerm ||
        entry.title.toLowerCase().includes(searchTerm) ||
        entry.content.toLowerCase().includes(searchTerm);

      const entryDate = this.parseJapaneseDate(entry.date);
      const matchesDateFrom = !dateFrom || entryDate >= new Date(dateFrom);
      const matchesToDate =
        !dateTo || entryDate <= new Date(dateTo + 'T23:59:59');

      return matchesSearch && matchesDateFrom && matchesToDate;
    });

    this.updateSearchResultsCount();
    this.renderEntries();
  }

  private parseJapaneseDate(dateString: string): Date {
    const match = dateString.match(/(\d{4})Âπ¥(\d{1,2})Êúà(\d{1,2})Êó•/);
    if (match) {
      const year = Number(match[1]);
      const month = Number(match[2]) - 1;
      const day = Number(match[3]);
      return new Date(year, month, day);
    }
    return new Date();
  }

  private updateSearchResultsCount() {
    const total = this.entries.length;
    const filtered = this.filteredEntries.length;

    if (
      this.currentSearchTerm ||
      this.dateFromInput.value ||
      this.dateToInput.value
    ) {
      this.searchResultsCount.textContent = `${filtered}‰ª∂ / ${total}‰ª∂`;
    } else {
      this.searchResultsCount.textContent = `${total}‰ª∂`;
    }
  }

  private clearFilters() {
    this.searchInput.value = '';
    this.dateFromInput.value = '';
    this.dateToInput.value = '';
    this.currentSearchTerm = '';
    this.applyFilters();
  }

  private createHighlightedElement(
    text: string,
    searchTerm: string
  ): DocumentFragment {
    const fragment = document.createDocumentFragment();

    if (!searchTerm) {
      fragment.appendChild(document.createTextNode(text));
      return fragment;
    }

    const regex = new RegExp(`(${searchTerm})`, 'gi');
    const parts = text.split(regex);

    parts.forEach(part => {
      if (part.toLowerCase() === searchTerm.toLowerCase()) {
        const mark = document.createElement('mark');
        mark.className = 'bg-yellow-200 px-1 rounded';
        mark.textContent = part;
        fragment.appendChild(mark);
      } else {
        fragment.appendChild(document.createTextNode(part));
      }
    });

    return fragment;
  }

  private renderEntries() {
    // Êó¢Â≠ò„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÇØ„É™„Ç¢
    this.diaryList.textContent = '';

    if (this.filteredEntries.length === 0 && this.entries.length === 0) {
      const emptyDiv = document.createElement('div');
      emptyDiv.className = 'text-center text-gray-500 py-8';

      const titleP = document.createElement('p');
      titleP.className = 'text-lg';
      titleP.textContent = '„Åæ„Å†Êó•Ë®ò„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';

      const subtitleP = document.createElement('p');
      subtitleP.className = 'text-sm';
      subtitleP.textContent = '‰∏ä„ÅÆ„Éï„Ç©„Éº„É†„Åã„ÇâÊúÄÂàù„ÅÆÊó•Ë®ò„ÇíÊõ∏„ÅÑ„Å¶„Åø„Åæ„Åó„Çá„ÅÜÔºÅ';

      emptyDiv.appendChild(titleP);
      emptyDiv.appendChild(subtitleP);
      this.diaryList.appendChild(emptyDiv);
      return;
    }

    if (this.filteredEntries.length === 0 && this.entries.length > 0) {
      const noResultsDiv = document.createElement('div');
      noResultsDiv.className = 'text-center text-gray-500 py-8';

      const titleP = document.createElement('p');
      titleP.className = 'text-lg';
      titleP.textContent = 'Ê§úÁ¥¢Êù°‰ª∂„Å´‰∏ÄËá¥„Åô„ÇãÊó•Ë®ò„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';

      const subtitleP = document.createElement('p');
      subtitleP.className = 'text-sm';
      subtitleP.textContent = 'Ê§úÁ¥¢Êù°‰ª∂„ÇíÂ§âÊõ¥„Åó„Å¶„Åø„Å¶„Åè„Å†„Åï„ÅÑ';

      noResultsDiv.appendChild(titleP);
      noResultsDiv.appendChild(subtitleP);
      this.diaryList.appendChild(noResultsDiv);
      return;
    }

    this.filteredEntries.forEach(entry => {
      const entryDiv = document.createElement('div');
      entryDiv.className =
        'border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow';

      const headerDiv = document.createElement('div');
      headerDiv.className = 'flex justify-between items-start mb-2';

      const titleH3 = document.createElement('h3');
      titleH3.className = 'text-lg font-medium text-gray-800';
      titleH3.appendChild(
        this.createHighlightedElement(entry.title, this.currentSearchTerm)
      );

      const buttonsDiv = document.createElement('div');
      buttonsDiv.className = 'flex space-x-2';

      const editButton = document.createElement('button');
      editButton.className =
        'text-blue-500 hover:text-blue-700 text-sm px-2 py-1 rounded transition-colors';
      editButton.title = 'Á∑®ÈõÜ';
      editButton.textContent = '‚úèÔ∏è';
      editButton.addEventListener('click', () => this.editEntry(entry.id));

      const deleteButton = document.createElement('button');
      deleteButton.className =
        'text-red-500 hover:text-red-700 text-sm px-2 py-1 rounded transition-colors';
      deleteButton.title = 'ÂâäÈô§';
      deleteButton.textContent = 'üóëÔ∏è';
      deleteButton.addEventListener('click', () => this.deleteEntry(entry.id));

      buttonsDiv.appendChild(editButton);
      buttonsDiv.appendChild(deleteButton);

      headerDiv.appendChild(titleH3);
      headerDiv.appendChild(buttonsDiv);

      const dateP = document.createElement('p');
      dateP.className = 'text-gray-600 text-sm mb-2';
      dateP.textContent = entry.date;

      const moodP = document.createElement('p');
      moodP.className = 'text-sm mb-2';
      if (entry.mood) {
        const moodRating = this.moodRatings.find(m => m.value === entry.mood);
        if (moodRating) {
          moodP.textContent = 'Ê∞óÂàÜ: ';

          const emojiSpan = document.createElement('span');
          emojiSpan.className = 'text-lg';
          emojiSpan.textContent = moodRating.emoji;

          const labelSpan = document.createElement('span');
          labelSpan.textContent = ` ${moodRating.label}`;

          moodP.appendChild(emojiSpan);
          moodP.appendChild(labelSpan);
        }
      } else {
        moodP.textContent = 'Ê∞óÂàÜ: Êú™Ë®≠ÂÆö';
        moodP.className = 'text-sm mb-2 text-gray-400';
      }

      const contentP = document.createElement('p');
      contentP.className = 'text-gray-700 leading-relaxed whitespace-pre-wrap';
      contentP.appendChild(
        this.createHighlightedElement(entry.content, this.currentSearchTerm)
      );

      entryDiv.appendChild(headerDiv);
      entryDiv.appendChild(dateP);
      entryDiv.appendChild(moodP);
      entryDiv.appendChild(contentP);

      if (entry.images && entry.images.length > 0) {
        this.appendImagesDisplay(entryDiv, entry.images);
      }

      if (entry.attachments && entry.attachments.length > 0) {
        this.appendAttachmentsDisplay(entryDiv, entry.attachments);
      }

      this.diaryList.appendChild(entryDiv);
    });
  }

  private initializeMoodSelector() {
    const moodContainer = document.getElementById('mood-selector');
    if (!moodContainer) return;

    this.moodRatings.forEach(mood => {
      const button = document.createElement('button');
      button.type = 'button';
      button.className =
        'mood-button p-3 border-2 rounded-lg transition-all hover:scale-105 focus:outline-none';

      const emojiDiv = document.createElement('div');
      emojiDiv.className = 'text-2xl mb-1';
      emojiDiv.textContent = mood.emoji;

      const labelDiv = document.createElement('div');
      labelDiv.className = 'text-xs';
      labelDiv.textContent = mood.label;

      button.appendChild(emojiDiv);
      button.appendChild(labelDiv);
      button.addEventListener('click', () => this.selectMood(mood.value));
      this.moodButtons.push(button);
      moodContainer.appendChild(button);
    });

    this.updateMoodSelection();
  }

  private selectMood(value: number) {
    this.selectedMood = this.selectedMood === value ? undefined : value;
    this.updateMoodSelection();
  }

  private updateMoodSelection() {
    this.moodButtons.forEach((button, index) => {
      const moodValue = this.moodRatings[index].value;
      if (this.selectedMood === moodValue) {
        button.className =
          'mood-button p-3 border-2 border-blue-500 bg-blue-50 rounded-lg transition-all hover:scale-105 focus:outline-none';
      } else {
        button.className =
          'mood-button p-3 border-2 border-gray-200 rounded-lg transition-all hover:scale-105 focus:outline-none';
      }
    });
  }

  private getMoodStats() {
    const moodCounts: { [key: number]: number } = {};
    let totalEntries = 0;

    this.entries.forEach(entry => {
      if (entry.mood) {
        moodCounts[entry.mood] = (moodCounts[entry.mood] || 0) + 1;
        totalEntries++;
      }
    });

    return {
      counts: moodCounts,
      total: totalEntries,
      average:
        totalEntries > 0
          ? Object.entries(moodCounts).reduce(
              (sum, [mood, count]) => sum + parseInt(mood) * count,
              0
            ) / totalEntries
          : 0,
    };
  }

  // ÊäïÁ®øÈ†ªÂ∫¶Áµ±Ë®à„ÇíÂèñÂæó
  private getPostFrequencyStats() {
    const frequencyData: { [key: string]: number } = {};
    const today = new Date();
    const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

    // ÈÅéÂéª30Êó•Èñì„ÅÆÊó•‰ªò„ÇíÁîüÊàê
    for (let i = 0; i <= 30; i++) {
      const d = new Date(thirtyDaysAgo.getTime() + i * 24 * 60 * 60 * 1000);
      const dateStr = d.toISOString().split('T')[0];
      frequencyData[dateStr] = 0;
    }

    // ÂêÑ„Ç®„É≥„Éà„É™„ÅÆÊäïÁ®øÊó•„Çí„Ç´„Ç¶„É≥„ÉàÔºàÊó•Êú¨Ë™ûÊó•‰ªòÂØæÂøúÔºâ
    this.entries.forEach(entry => {
      try {
        let entryDate: Date;

        // Êó•Êú¨Ë™ûÂΩ¢Âºè„ÅÆÊó•‰ªò„Åã„Å©„ÅÜ„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (
          entry.date.includes('Âπ¥') &&
          entry.date.includes('Êúà') &&
          entry.date.includes('Êó•')
        ) {
          entryDate = this.parseJapaneseDate(entry.date);
        } else {
          entryDate = new Date(entry.date);
        }

        if (isNaN(entryDate.getTime())) {
          console.warn('Invalid date found in entry:', entry.date);
          return;
        }

        const dateStr = entryDate.toISOString().split('T')[0];
        if (frequencyData.hasOwnProperty(dateStr)) {
          frequencyData[dateStr]++;
        }
      } catch (error) {
        console.warn('Error processing entry date:', entry.date, error);
      }
    });

    // ÈÄ±Èñì„ÄÅÊúàÈñìÁµ±Ë®à„ÇíË®àÁÆó
    const weeklyData: { [key: string]: number } = {};
    const monthlyData: { [key: string]: number } = {};

    Object.entries(frequencyData).forEach(([date, count]) => {
      try {
        const d = new Date(date);
        if (isNaN(d.getTime())) return;

        const weekKey = this.getWeekKey(d);
        const monthKey =
          d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0');

        weeklyData[weekKey] = (weeklyData[weekKey] || 0) + count;
        monthlyData[monthKey] = (monthlyData[monthKey] || 0) + count;
      } catch (error) {
        console.warn('Error processing date in frequency data:', date, error);
      }
    });

    return {
      daily: frequencyData,
      weekly: weeklyData,
      monthly: monthlyData,
      totalPosts: this.entries.length,
      averagePerDay:
        this.entries.length > 0
          ? this.entries.length / Object.keys(frequencyData).length
          : 0,
    };
  }

  // ÈÄ±„ÅÆ„Ç≠„Éº„ÇíÁîüÊàêÔºàÂπ¥-ÈÄ±Áï™Âè∑Ôºâ
  private getWeekKey(date: Date): string {
    const year = date.getFullYear();
    const oneJan = new Date(year, 0, 1);
    const numberOfDays = Math.floor(
      (date.getTime() - oneJan.getTime()) / (24 * 60 * 60 * 1000)
    );
    const weekNumber = Math.ceil((date.getDay() + 1 + numberOfDays) / 7);
    return `${year}-W${String(weekNumber).padStart(2, '0')}`;
  }

  // ÊñáÂ≠óÊï∞„Éà„É¨„É≥„ÉâÁµ±Ë®à„ÇíÂèñÂæó
  private getCharacterTrends() {
    const trends: { date: string; count: number; title: string }[] = [];

    this.entries
      .filter(entry => {
        // ÊúâÂäπ„Å™Êó•‰ªò„ÅÆ„Åø„Çí„Éï„Ç£„É´„ÇøÔºàÊó•Êú¨Ë™ûÊó•‰ªòÂØæÂøúÔºâ
        try {
          let date: Date;
          if (
            entry.date.includes('Âπ¥') &&
            entry.date.includes('Êúà') &&
            entry.date.includes('Êó•')
          ) {
            date = this.parseJapaneseDate(entry.date);
          } else {
            date = new Date(entry.date);
          }
          return !isNaN(date.getTime());
        } catch {
          return false;
        }
      })
      .sort((a, b) => {
        // „ÇΩ„Éº„ÉàÁî®„ÅÆÊó•‰ªòÂ§âÊèõÔºàÊó•Êú¨Ë™ûÊó•‰ªòÂØæÂøúÔºâ
        const getDateForSort = (dateStr: string) => {
          if (
            dateStr.includes('Âπ¥') &&
            dateStr.includes('Êúà') &&
            dateStr.includes('Êó•')
          ) {
            return this.parseJapaneseDate(dateStr);
          }
          return new Date(dateStr);
        };
        return (
          getDateForSort(a.date).getTime() - getDateForSort(b.date).getTime()
        );
      })
      .forEach(entry => {
        const totalChars =
          (entry.title?.length || 0) + (entry.content?.length || 0);
        trends.push({
          date: entry.date,
          count: totalChars,
          title: entry.title,
        });
      });

    // Áµ±Ë®àË®àÁÆó
    const counts = trends.map(t => t.count);
    const averageCharCount =
      counts.length > 0
        ? counts.reduce((sum, count) => sum + count, 0) / counts.length
        : 0;
    const maxCharCount = counts.length > 0 ? Math.max(...counts) : 0;
    const minCharCount = counts.length > 0 ? Math.min(...counts) : 0;

    // ÊúÄËøë7Êó•Èñì„ÅÆÂπ≥Âùá
    const recentTrends = trends.slice(-7);
    const recentAverage =
      recentTrends.length > 0
        ? recentTrends.reduce((sum, t) => sum + t.count, 0) /
          recentTrends.length
        : 0;

    return {
      trends,
      averageCharCount: Math.round(averageCharCount),
      maxCharCount,
      minCharCount,
      recentAverage: Math.round(recentAverage),
      totalEntries: trends.length,
    };
  }

  // Á∂ôÁ∂öÊó•Êï∞„Ç´„Ç¶„É≥„Çø„ÇíÂèñÂæó
  private getContinuousDaysStats() {
    if (this.entries.length === 0) {
      return {
        currentStreak: 0,
        maxStreak: 0,
        lastPostDate: null,
        streakStartDate: null,
        totalDaysPosted: 0,
      };
    }

    // ÊúâÂäπ„Å™Êó•‰ªò„ÅÆ„Åø„ÇíÂèñÂæó„Åó„Å¶„ÇΩ„Éº„Éà„Åó„Å¶„É¶„Éã„Éº„ÇØ„Å™ÊäïÁ®øÊó•„ÇíÂèñÂæóÔºàÊó•Êú¨Ë™ûÊó•‰ªòÂØæÂøúÔºâ
    const validDates = this.entries
      .map(entry => {
        try {
          let date: Date;
          if (
            entry.date.includes('Âπ¥') &&
            entry.date.includes('Êúà') &&
            entry.date.includes('Êó•')
          ) {
            date = this.parseJapaneseDate(entry.date);
          } else {
            date = new Date(entry.date);
          }

          if (isNaN(date.getTime())) {
            return null;
          }

          return date.toISOString().split('T')[0];
        } catch {
          return null;
        }
      })
      .filter((dateStr): dateStr is string => dateStr !== null);

    const uniqueDates = [...new Set(validDates)].sort();

    if (uniqueDates.length === 0) {
      return {
        currentStreak: 0,
        maxStreak: 0,
        lastPostDate: null,
        streakStartDate: null,
        totalDaysPosted: 0,
      };
    }

    let maxStreak = 0;
    let currentStreak = 1;

    // ÊúÄÈï∑ÈÄ£Á∂öË®òÈå≤„ÇíË®àÁÆó
    for (let i = 1; i < uniqueDates.length; i++) {
      const prevDate = new Date(uniqueDates[i - 1]);
      const currDate = new Date(uniqueDates[i]);
      const dayDiff =
        (currDate.getTime() - prevDate.getTime()) / (1000 * 60 * 60 * 24);

      if (dayDiff === 1) {
        currentStreak++;
      } else {
        if (currentStreak > maxStreak) {
          maxStreak = currentStreak;
        }
        currentStreak = 1;
      }
    }

    // ÊúÄÂæå„ÅÆ„Çπ„Éà„É™„Éº„ÇØ„ÉÅ„Çß„ÉÉ„ÇØ
    if (currentStreak > maxStreak) {
      maxStreak = currentStreak;
    }

    // ÁèæÂú®„ÅÆ„Çπ„Éà„É™„Éº„ÇØË®àÁÆó
    const today = new Date();
    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
    const lastPostDate = uniqueDates[uniqueDates.length - 1];

    let currentActiveStreak = 0;
    let activeStreakStart = null;

    if (
      lastPostDate === today.toISOString().split('T')[0] ||
      lastPostDate === yesterday.toISOString().split('T')[0]
    ) {
      // ‰ªäÊó•„Åæ„Åü„ÅØÊò®Êó•„Å´ÊäïÁ®ø„Åå„ÅÇ„Å£„ÅüÂ†¥Âêà„ÄÅÁèæÂú®„ÅÆ„Çπ„Éà„É™„Éº„ÇØ„ÇíË®àÁÆó
      currentActiveStreak = 1;
      activeStreakStart = lastPostDate;

      for (let i = uniqueDates.length - 2; i >= 0; i--) {
        const currDate = new Date(uniqueDates[i]);
        const nextDate = new Date(uniqueDates[i + 1]);
        const dayDiff =
          (nextDate.getTime() - currDate.getTime()) / (1000 * 60 * 60 * 24);

        if (dayDiff === 1) {
          currentActiveStreak++;
          activeStreakStart = uniqueDates[i];
        } else {
          break;
        }
      }
    }

    return {
      currentStreak: currentActiveStreak,
      maxStreak,
      lastPostDate: lastPostDate,
      streakStartDate: activeStreakStart,
      totalDaysPosted: uniqueDates.length,
    };
  }

  private renderMoodStats() {
    const statsContainer = document.getElementById('mood-stats');
    if (!statsContainer) return;

    // Êó¢Â≠ò„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÇØ„É™„Ç¢
    statsContainer.textContent = '';

    const stats = this.getMoodStats();

    if (stats.total === 0) {
      const noDataP = document.createElement('p');
      noDataP.className = 'text-gray-500 text-center';
      noDataP.textContent = '„Åæ„Å†Ê∞óÂàÜ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
      statsContainer.appendChild(noDataP);
      return;
    }

    // „Ç∞„É™„ÉÉ„Éâ„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    const gridDiv = document.createElement('div');
    gridDiv.className = 'grid grid-cols-2 md:grid-cols-3 gap-4 mb-4';

    // ÂêÑÊ∞óÂàÜ„ÅÆÁµ±Ë®à„Çí‰ΩúÊàê
    this.moodRatings.forEach(mood => {
      const count = stats.counts[mood.value] || 0;
      const percentage =
        stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;

      const statDiv = document.createElement('div');
      statDiv.className = 'text-center p-3 bg-gray-50 rounded-lg';

      const emojiDiv = document.createElement('div');
      emojiDiv.className = 'text-2xl mb-1';
      emojiDiv.textContent = mood.emoji;

      const countDiv = document.createElement('div');
      countDiv.className = 'text-sm font-semibold';
      countDiv.textContent = `${count}Âõû`;

      const percentageDiv = document.createElement('div');
      percentageDiv.className = 'text-xs text-gray-600';
      percentageDiv.textContent = `${percentage}%`;

      statDiv.appendChild(emojiDiv);
      statDiv.appendChild(countDiv);
      statDiv.appendChild(percentageDiv);
      gridDiv.appendChild(statDiv);
    });

    // Âπ≥ÂùáÊ∞óÂàÜ„Çª„ÇØ„Ç∑„Éß„É≥„Çí‰ΩúÊàê
    const averageDiv = document.createElement('div');
    averageDiv.className = 'text-center p-3 bg-blue-50 rounded-lg';

    const averageLabelDiv = document.createElement('div');
    averageLabelDiv.className = 'text-sm text-gray-600';
    averageLabelDiv.textContent = 'Âπ≥ÂùáÊ∞óÂàÜ';

    const averageValueDiv = document.createElement('div');
    averageValueDiv.className = 'text-lg';

    const averageMood = this.moodRatings.find(
      m => Math.round(stats.average) === m.value
    );

    if (averageMood) {
      averageValueDiv.textContent = `${averageMood.emoji} ${averageMood.label}`;
    } else {
      averageValueDiv.textContent = 'Ë®àÁÆó‰∏≠...';
    }

    const averageScoreDiv = document.createElement('div');
    averageScoreDiv.className = 'text-xs text-gray-600';
    averageScoreDiv.textContent = `${stats.average.toFixed(1)} / 5.0`;

    averageDiv.appendChild(averageLabelDiv);
    averageDiv.appendChild(averageValueDiv);
    averageDiv.appendChild(averageScoreDiv);

    statsContainer.appendChild(gridDiv);
    statsContainer.appendChild(averageDiv);
  }

  // ÊäïÁ®øÈ†ªÂ∫¶Áµ±Ë®à„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  private renderPostFrequencyStats() {
    const statsContainer = document.getElementById('post-frequency-stats');
    if (!statsContainer) return;

    statsContainer.textContent = '';

    const stats = this.getPostFrequencyStats();

    // Á∑èÊäïÁ®øÊï∞„Å®Âπ≥Âùá
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6';

    const totalPostsDiv = this.createStatCard(
      'üìù',
      'Á∑èÊäïÁ®øÊï∞',
      `${stats.totalPosts}‰ª∂`
    );
    const avgPerDayDiv = this.createStatCard(
      'üìä',
      '1Êó•Âπ≥Âùá',
      `${stats.averagePerDay.toFixed(1)}‰ª∂`
    );
    const recentWeekTotal = Object.values(stats.weekly).slice(-1)[0] || 0;
    const recentWeekDiv = this.createStatCard(
      'üìÖ',
      '‰ªäÈÄ±',
      `${recentWeekTotal}‰ª∂`
    );
    const recentMonthTotal = Object.values(stats.monthly).slice(-1)[0] || 0;
    const recentMonthDiv = this.createStatCard(
      'üóìÔ∏è',
      '‰ªäÊúà',
      `${recentMonthTotal}‰ª∂`
    );

    summaryDiv.appendChild(totalPostsDiv);
    summaryDiv.appendChild(avgPerDayDiv);
    summaryDiv.appendChild(recentWeekDiv);
    summaryDiv.appendChild(recentMonthDiv);
    statsContainer.appendChild(summaryDiv);

    // ÈÅéÂéª7Êó•Èñì„ÅÆ„ÉÅ„É£„Éº„Éà
    const recentDays = Object.entries(stats.daily).slice(-7);
    if (recentDays.length > 0) {
      const chartDiv = document.createElement('div');
      chartDiv.className = 'bg-gray-50 p-4 rounded-lg';

      const chartTitle = document.createElement('h4');
      chartTitle.className = 'text-sm font-medium text-gray-700 mb-3';
      chartTitle.textContent = 'ÈÅéÂéª7Êó•Èñì„ÅÆÊäïÁ®øÊï∞';
      chartDiv.appendChild(chartTitle);

      const barsContainer = document.createElement('div');
      barsContainer.className = 'flex items-end justify-between gap-1 h-24';

      const maxCount = Math.max(...recentDays.map(([_, count]) => count));

      recentDays.forEach(([date, count]) => {
        const barContainer = document.createElement('div');
        barContainer.className = 'flex-1 flex flex-col items-center';

        const bar = document.createElement('div');
        bar.className = 'w-full bg-blue-500 rounded-sm';
        const height = maxCount > 0 ? (count / maxCount) * 100 : 0;
        bar.style.height = `${Math.max(height, 2)}%`;

        const label = document.createElement('span');
        label.className = 'text-xs text-gray-600 mt-1';
        label.textContent = new Date(date).getDate().toString();

        const countLabel = document.createElement('span');
        countLabel.className = 'text-xs text-gray-500';
        countLabel.textContent = count.toString();

        barContainer.appendChild(bar);
        barContainer.appendChild(label);
        if (count > 0) barContainer.appendChild(countLabel);

        barsContainer.appendChild(barContainer);
      });

      chartDiv.appendChild(barsContainer);
      statsContainer.appendChild(chartDiv);
    }
  }

  // ÊñáÂ≠óÊï∞„Éà„É¨„É≥„Éâ„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  private renderCharacterTrends() {
    const statsContainer = document.getElementById('character-trends');
    if (!statsContainer) return;

    statsContainer.textContent = '';

    const trends = this.getCharacterTrends();

    if (trends.totalEntries === 0) {
      const noDataP = document.createElement('p');
      noDataP.className = 'text-gray-500 text-center';
      noDataP.textContent = '„Åæ„Å†„Ç®„É≥„Éà„É™„Åå„ÅÇ„Çä„Åæ„Åõ„Çì';
      statsContainer.appendChild(noDataP);
      return;
    }

    // ÊñáÂ≠óÊï∞Áµ±Ë®à„Çµ„Éû„É™„Éº
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6';

    const avgDiv = this.createStatCard(
      'üìä',
      'Âπ≥ÂùáÊñáÂ≠óÊï∞',
      `${trends.averageCharCount}ÊñáÂ≠ó`
    );
    const maxDiv = this.createStatCard(
      'üìà',
      'ÊúÄÂ§ßÊñáÂ≠óÊï∞',
      `${trends.maxCharCount}ÊñáÂ≠ó`
    );
    const minDiv = this.createStatCard(
      'üìâ',
      'ÊúÄÂ∞èÊñáÂ≠óÊï∞',
      `${trends.minCharCount}ÊñáÂ≠ó`
    );
    const recentDiv = this.createStatCard(
      'üìÖ',
      'ÊúÄËøë7Êó•Âπ≥Âùá',
      `${trends.recentAverage}ÊñáÂ≠ó`
    );

    summaryDiv.appendChild(avgDiv);
    summaryDiv.appendChild(maxDiv);
    summaryDiv.appendChild(minDiv);
    summaryDiv.appendChild(recentDiv);
    statsContainer.appendChild(summaryDiv);

    // ÊúÄËøë„ÅÆÊäïÁ®ø„Éà„É¨„É≥„Éâ
    const recentTrends = trends.trends.slice(-10);
    if (recentTrends.length > 0) {
      const trendDiv = document.createElement('div');
      trendDiv.className = 'bg-gray-50 p-4 rounded-lg';

      const trendTitle = document.createElement('h4');
      trendTitle.className = 'text-sm font-medium text-gray-700 mb-3';
      trendTitle.textContent = 'ÊúÄËøë„ÅÆÊñáÂ≠óÊï∞Êé®Áßª';
      trendDiv.appendChild(trendTitle);

      const trendsContainer = document.createElement('div');
      trendsContainer.className = 'space-y-2';

      recentTrends.forEach(trend => {
        const trendItem = document.createElement('div');
        trendItem.className = 'flex justify-between items-center text-sm';

        const dateDiv = document.createElement('div');
        dateDiv.className = 'text-gray-600';

        // Êó•Êú¨Ë™ûÊó•‰ªò„ÅÆÂá¶ÁêÜ
        let displayDate: string;
        try {
          let date: Date;
          if (
            trend.date.includes('Âπ¥') &&
            trend.date.includes('Êúà') &&
            trend.date.includes('Êó•')
          ) {
            date = this.parseJapaneseDate(trend.date);
            displayDate = date.toLocaleDateString('ja-JP');
          } else {
            date = new Date(trend.date);
            displayDate = date.toLocaleDateString('ja-JP');
          }
        } catch {
          displayDate = trend.date; // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÂÖÉ„ÅÆÊñáÂ≠óÂàó„Çí„Åù„ÅÆ„Åæ„ÅæË°®Á§∫
        }

        dateDiv.textContent = displayDate;

        const titleDiv = document.createElement('div');
        titleDiv.className = 'flex-1 mx-3 truncate';
        titleDiv.textContent = trend.title || 'ÁÑ°È°å';

        const countDiv = document.createElement('div');
        countDiv.className = 'font-medium';
        countDiv.textContent = `${trend.count}ÊñáÂ≠ó`;

        trendItem.appendChild(dateDiv);
        trendItem.appendChild(titleDiv);
        trendItem.appendChild(countDiv);
        trendsContainer.appendChild(trendItem);
      });

      trendDiv.appendChild(trendsContainer);
      statsContainer.appendChild(trendDiv);
    }
  }

  // Á∂ôÁ∂öÊó•Êï∞Áµ±Ë®à„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞
  private renderContinuousStats() {
    const statsContainer = document.getElementById('continuous-stats');
    if (!statsContainer) return;

    statsContainer.textContent = '';

    const stats = this.getContinuousDaysStats();

    // Á∂ôÁ∂öÁµ±Ë®à„Çµ„Éû„É™„Éº
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'grid grid-cols-2 md:grid-cols-4 gap-4 mb-6';

    const currentStreakDiv = this.createStatCard(
      'üî•',
      'ÁèæÂú®„ÅÆÈÄ£Á∂öÊó•Êï∞',
      `${stats.currentStreak}Êó•`,
      stats.currentStreak > 0 ? 'bg-orange-50 border-orange-200' : 'bg-gray-50'
    );
    const maxStreakDiv = this.createStatCard(
      'üèÜ',
      'ÊúÄÈï∑ÈÄ£Á∂öË®òÈå≤',
      `${stats.maxStreak}Êó•`
    );
    const totalDaysDiv = this.createStatCard(
      'üìÖ',
      'ÊäïÁ®øÊó•Êï∞',
      `${stats.totalDaysPosted}Êó•`
    );

    const lastPostDiv = this.createStatCard(
      'üìù',
      'ÊúÄÁµÇÊäïÁ®øÊó•',
      stats.lastPostDate
        ? new Date(stats.lastPostDate).toLocaleDateString('ja-JP')
        : 'Êú™ÊäïÁ®ø'
    );

    summaryDiv.appendChild(currentStreakDiv);
    summaryDiv.appendChild(maxStreakDiv);
    summaryDiv.appendChild(totalDaysDiv);
    summaryDiv.appendChild(lastPostDiv);
    statsContainer.appendChild(summaryDiv);

    // ÈÄ£Á∂öÊäïÁ®ø„ÅÆ„É¢„ÉÅ„Éô„Éº„Ç∑„Éß„É≥„É°„ÉÉ„Çª„Éº„Ç∏
    const motivationDiv = document.createElement('div');
    motivationDiv.className = 'bg-blue-50 p-4 rounded-lg text-center';

    const motivationText = document.createElement('p');
    motivationText.className = 'text-sm text-blue-800';

    if (stats.currentStreak === 0) {
      motivationText.textContent = '‰ªäÊó•„Åã„ÇâÊó•Ë®ò„ÇíÂßã„ÇÅ„Å¶„Åø„Åæ„Åõ„Çì„ÅãÔºü üìù';
    } else if (stats.currentStreak === 1) {
      motivationText.textContent =
        '„ÅÑ„ÅÑ„Çπ„Çø„Éº„Éà„Åß„ÅôÔºÅÊòéÊó•„ÇÇÁ∂ö„Åë„Å¶„Åø„Åæ„Åó„Çá„ÅÜ üåü';
    } else if (stats.currentStreak < 7) {
      motivationText.textContent = `${stats.currentStreak}Êó•ÈÄ£Á∂öÔºÅ„ÅÑ„ÅÑË™øÂ≠ê„Åß„Åô üéâ`;
    } else if (stats.currentStreak < 30) {
      motivationText.textContent = `${stats.currentStreak}Êó•ÈÄ£Á∂öÔºÅÁ¥†Êô¥„Çâ„Åó„ÅÑÁøíÊÖ£„Åß„Åô üî•`;
    } else {
      motivationText.textContent = `${stats.currentStreak}Êó•ÈÄ£Á∂öÔºÅÈ©öÁï∞ÁöÑ„Å™Á∂ôÁ∂öÂäõ„Åß„ÅôÔºÅ üèÜ`;
    }

    motivationDiv.appendChild(motivationText);
    statsContainer.appendChild(motivationDiv);
  }

  // Áµ±Ë®à„Ç´„Éº„Éâ„Çí‰ΩúÊàê„Åô„Çã„Éò„É´„Éë„Éº„É°„ÇΩ„ÉÉ„Éâ
  private createStatCard(
    icon: string,
    label: string,
    value: string,
    additionalClasses: string = ''
  ) {
    const card = document.createElement('div');
    card.className = `text-center p-4 bg-white border rounded-lg ${additionalClasses}`;

    const iconDiv = document.createElement('div');
    iconDiv.className = 'text-2xl mb-2';
    iconDiv.textContent = icon;

    const labelDiv = document.createElement('div');
    labelDiv.className = 'text-sm text-gray-600 mb-1';
    labelDiv.textContent = label;

    const valueDiv = document.createElement('div');
    valueDiv.className = 'text-lg font-semibold';
    valueDiv.textContent = value;

    card.appendChild(iconDiv);
    card.appendChild(labelDiv);
    card.appendChild(valueDiv);

    return card;
  }

  private getMoodChartData(period: 'month' | 'year') {
    const now = new Date();
    const chartData: { [key: string]: number[] } = {};

    this.entries.forEach(entry => {
      if (!entry.mood) return;

      const entryDate = this.parseJapaneseDate(entry.date);
      let key: string;

      if (period === 'month') {
        if (
          entryDate.getFullYear() === now.getFullYear() &&
          entryDate.getMonth() === now.getMonth()
        ) {
          key = entryDate.getDate().toString();
        } else {
          return;
        }
      } else {
        if (entryDate.getFullYear() === now.getFullYear()) {
          key = (entryDate.getMonth() + 1).toString();
        } else {
          return;
        }
      }

      if (!chartData[key]) {
        chartData[key] = [];
      }
      chartData[key].push(entry.mood);
    });

    return Object.entries(chartData)
      .map(([key, moods]) => ({
        label: period === 'month' ? `${key}Êó•` : `${key}Êúà`,
        average: moods.reduce((sum, mood) => sum + mood, 0) / moods.length,
        count: moods.length,
      }))
      .sort((a, b) => parseInt(a.label) - parseInt(b.label));
  }

  private renderMoodChart() {
    const chartContainer = document.getElementById('mood-chart');
    if (!chartContainer) return;

    // Êó¢Â≠ò„ÅÆ„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Çí„ÇØ„É™„Ç¢
    chartContainer.textContent = '';

    const monthData = this.getMoodChartData('month');
    const yearData = this.getMoodChartData('year');

    // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    const mainDiv = document.createElement('div');
    mainDiv.className = 'mb-4';

    // „Éú„Çø„É≥„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'flex gap-2 mb-4';

    const monthButton = document.createElement('button');
    monthButton.id = 'chart-month';
    monthButton.className =
      'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600';
    monthButton.textContent = '‰ªäÊúà';

    const yearButton = document.createElement('button');
    yearButton.id = 'chart-year';
    yearButton.className =
      'px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
    yearButton.textContent = '‰ªäÂπ¥';

    buttonDiv.appendChild(monthButton);
    buttonDiv.appendChild(yearButton);

    // „ÉÅ„É£„Éº„Éà„Ç≥„É≥„ÉÜ„É≥„ÉÑ„Ç≥„É≥„ÉÜ„Éä„Çí‰ΩúÊàê
    const chartContent = document.createElement('div');
    chartContent.id = 'chart-content';

    mainDiv.appendChild(buttonDiv);
    mainDiv.appendChild(chartContent);
    chartContainer.appendChild(mainDiv);

    const showChart = (data: any[], type: string) => {
      // Êó¢Â≠ò„ÅÆ„ÉÅ„É£„Éº„Éà„Çí„ÇØ„É™„Ç¢
      chartContent.textContent = '';

      if (data.length === 0) {
        const noDataP = document.createElement('p');
        noDataP.className = 'text-gray-500 text-center';
        noDataP.textContent = `„Åì„ÅÆ${type}„ÅÆÊ∞óÂàÜ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì`;
        chartContent.appendChild(noDataP);
        return;
      }

      const maxValue = 5;
      const chartDiv = document.createElement('div');
      chartDiv.className = 'space-y-2';

      data.forEach(item => {
        const percentage = (item.average / maxValue) * 100;
        const moodEmoji =
          this.moodRatings.find(m => Math.round(item.average) === m.value)
            ?.emoji || 'üòä';

        const rowDiv = document.createElement('div');
        rowDiv.className = 'flex items-center gap-3';

        const labelDiv = document.createElement('div');
        labelDiv.className = 'w-12 text-sm text-gray-600';
        labelDiv.textContent = item.label;

        const barContainerDiv = document.createElement('div');
        barContainerDiv.className =
          'flex-1 bg-gray-200 rounded-full h-6 relative';

        const barDiv = document.createElement('div');
        barDiv.className = 'bg-blue-500 h-6 rounded-full transition-all';
        barDiv.style.width = `${percentage}%`;

        const textDiv = document.createElement('div');
        textDiv.className =
          'absolute inset-0 flex items-center justify-center text-sm';
        textDiv.textContent = `${moodEmoji} ${item.average.toFixed(1)} (${
          item.count
        }Âõû)`;

        barContainerDiv.appendChild(barDiv);
        barContainerDiv.appendChild(textDiv);

        rowDiv.appendChild(labelDiv);
        rowDiv.appendChild(barContainerDiv);
        chartDiv.appendChild(rowDiv);
      });

      chartContent.appendChild(chartDiv);
    };

    monthButton.addEventListener('click', () => {
      monthButton.className =
        'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600';
      yearButton.className =
        'px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
      showChart(monthData, 'Êúà');
    });

    yearButton.addEventListener('click', () => {
      yearButton.className =
        'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600';
      monthButton.className =
        'px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300';
      showChart(yearData, 'Âπ¥');
    });

    // ÂàùÊúüË°®Á§∫
    showChart(monthData, 'Êúà');
  }

  private updateMoodFeatures() {
    this.renderPostFrequencyStats();
    this.renderCharacterTrends();
    this.renderContinuousStats();
    this.renderMoodStats();
    this.renderMoodChart();
  }

  private exportToJSON() {
    try {
      const exportData = {
        version: '1.0',
        exportDate: new Date().toISOString(),
        entries: this.entries,
        moodStats: this.getMoodStats(),
      };

      const jsonString = JSON.stringify(exportData, null, 2);
      const blob = new Blob([jsonString], { type: 'application/json' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `diary-backup-${
        new Date().toISOString().split('T')[0]
      }.json`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);

      alert('JSON„Éï„Ç°„Ç§„É´„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü');
    } catch (error) {
      console.error('JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
      alert('JSON„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }

  private async loadPDFTemplate(): Promise<string> {
    try {
      const response = await fetch('/src/pdf-template.html');
      if (!response.ok) {
        throw new Error('PDF„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
      }
      return await response.text();
    } catch (error) {
      console.error('PDF„ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
      // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁî®„ÅÆ„Ç∑„É≥„Éó„É´„Å™„ÉÜ„É≥„Éó„É¨„Éº„Éà
      return this.getFallbackPDFTemplate();
    }
  }

  private getFallbackPDFTemplate(): string {
    return `
      <!DOCTYPE html>
      <html lang="ja">
      <head>
        <meta charset="UTF-8">
        <title>{{TITLE}}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
          .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
          .stats { margin-bottom: 30px; padding: 15px; background-color: #f5f5f5; border-radius: 5px; }
          .entry { margin-bottom: 25px; padding: 15px; border: 1px solid #ddd; border-radius: 5px; page-break-inside: avoid; }
          .entry-title { font-size: 18px; font-weight: bold; margin-bottom: 5px; }
          .entry-date { color: #666; font-size: 14px; margin-bottom: 5px; }
          .entry-mood { color: #555; font-size: 14px; margin-bottom: 10px; }
          .entry-content { white-space: pre-wrap; }
          @media print { body { margin: 0; } }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>üìù My Diary</h1>
          <p>„Ç®„ÇØ„Çπ„Éù„Éº„ÉàÊó•: {{EXPORT_DATE}}</p>
        </div>
        <div class="stats">
          <h2>üìä Áµ±Ë®àÊÉÖÂ†±</h2>
          <p>Á∑è„Ç®„É≥„Éà„É™„ÉºÊï∞: {{TOTAL_ENTRIES}}‰ª∂</p>
          <p>Ê∞óÂàÜ„Éá„Éº„Çø: {{MOOD_ENTRIES}}‰ª∂</p>
          <p>Âπ≥ÂùáÊ∞óÂàÜ: {{AVERAGE_MOOD}}</p>
          {{MOOD_STATS}}
        </div>
        <div class="entries">{{ENTRIES}}</div>
      </body>
      </html>
    `;
  }

  private generateMoodStatsForPDF(stats: any): string {
    if (stats.total === 0) {
      return '<p class="text-gray-500">Ê∞óÂàÜ„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</p>';
    }

    // PDF„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁî®„ÅÆHTML„ÅØÁ∂≠ÊåÅÔºàÂç∞Âà∑„ÅÆ„Åü„ÇÅÔºâ
    return this.moodRatings
      .map(mood => {
        const count = stats.counts[mood.value] || 0;
        const percentage =
          stats.total > 0 ? Math.round((count / stats.total) * 100) : 0;

        return `
        <div class="stat-item">
          <div class="stat-emoji">${mood.emoji}</div>
          <div class="stat-count">${count}Âõû</div>
          <div class="stat-percentage">${percentage}%</div>
          <div class="text-xs text-gray-600">${mood.label}</div>
        </div>
      `;
      })
      .join('');
  }

  private generateEntriesForPDF(entries: DiaryEntry[]): string {
    // PDF„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁî®„ÅÆHTML„ÅØÁ∂≠ÊåÅÔºàÂç∞Âà∑„ÅÆ„Åü„ÇÅÔºâ
    return entries
      .map(entry => {
        const moodRating = entry.mood
          ? this.moodRatings.find(m => m.value === entry.mood)
          : null;

        return `
        <div class="entry no-break">
          <div class="entry-title">${this.escapeHtml(entry.title)}</div>
          <div class="entry-date">${entry.date}</div>
          ${
            moodRating
              ? `<div class="entry-mood">Ê∞óÂàÜ: ${moodRating.emoji} ${moodRating.label}</div>`
              : ''
          }
          <div class="entry-content">${this.escapeHtml(entry.content)}</div>
        </div>
      `;
      })
      .join('');
  }

  private escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  private async exportToPDF() {
    try {
      const stats = this.getMoodStats();
      const sortedEntries = [...this.entries].sort(
        (a, b) =>
          this.parseJapaneseDate(b.date).getTime() -
          this.parseJapaneseDate(a.date).getTime()
      );

      // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíË™≠„ÅøËæº„Åø
      const template = await this.loadPDFTemplate();

      // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂ§âÊï∞„ÇíÁΩÆÊèõ
      const htmlContent = template
        .replace(/{{TITLE}}/g, 'Êó•Ë®ò„Ç®„ÇØ„Çπ„Éù„Éº„Éà')
        .replace(/{{EXPORT_DATE}}/g, new Date().toLocaleDateString('ja-JP'))
        .replace(/{{TOTAL_ENTRIES}}/g, this.entries.length.toString())
        .replace(/{{MOOD_ENTRIES}}/g, stats.total.toString())
        .replace(
          /{{AVERAGE_MOOD}}/g,
          stats.total > 0 ? `${stats.average.toFixed(1)} / 5.0` : 'Êú™Ë®≠ÂÆö'
        )
        .replace(/{{MOOD_STATS}}/g, this.generateMoodStatsForPDF(stats))
        .replace(/{{ENTRIES}}/g, this.generateEntriesForPDF(sortedEntries));

      const blob = new Blob([htmlContent], { type: 'text/html' });
      const url = URL.createObjectURL(blob);

      const printWindow = window.open(url, '_blank');
      if (!printWindow) {
        alert(
          '„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„Åå„Éñ„É≠„ÉÉ„ÇØ„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ'
        );
        URL.revokeObjectURL(url);
        return;
      }

      printWindow.addEventListener('load', () => {
        setTimeout(() => {
          printWindow.print();
          printWindow.addEventListener('afterprint', () => {
            printWindow.close();
            URL.revokeObjectURL(url);
          });
        }, 1000); // „ÉÜ„É≥„Éó„É¨„Éº„ÉàË™≠„ÅøËæº„ÅøÊôÇÈñì„ÇíËÄÉÊÖÆ„Åó„Å¶Â∞ë„ÅóÈï∑„ÇÅ„Å´
      });
    } catch (error) {
      console.error('PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Ç®„É©„Éº:', error);
      alert('PDF„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }

  private backupData() {
    try {
      const backupData = {
        version: '1.0',
        backupDate: new Date().toISOString(),
        entries: this.entries,
        settings: {
          lastBackup: new Date().toISOString(),
        },
      };

      localStorage.setItem('diary-backup', JSON.stringify(backupData));
      alert(
        `„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (${this.entries.length}‰ª∂„ÅÆ„Ç®„É≥„Éà„É™„Éº)`
      );
    } catch (error) {
      console.error('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Ç®„É©„Éº:', error);
      alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }

  private restoreData() {
    try {
      const backupData = localStorage.getItem('diary-backup');
      if (!backupData) {
        alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
        return;
      }

      const confirmed = confirm(
        'ÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÂæ©ÂÖÉ„ÇíÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü'
      );
      if (!confirmed) return;

      const parsedData = JSON.parse(backupData);
      if (parsedData.entries && Array.isArray(parsedData.entries)) {
        this.entries = parsedData.entries;
        this.saveEntries();
        this.updateMoodFeatures();
        this.applyFilters();
        alert(`Âæ©ÂÖÉ„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (${this.entries.length}‰ª∂„ÅÆ„Ç®„É≥„Éà„É™„Éº)`);
      } else {
        alert('„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó„Éá„Éº„Çø„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
      }
    } catch (error) {
      console.error('Âæ©ÂÖÉ„Ç®„É©„Éº:', error);
      alert('Âæ©ÂÖÉ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }

  private importFromFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.addEventListener('change', e => {
      const file = (e.target as HTMLInputElement).files?.[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = e => {
        try {
          const importData = JSON.parse(e.target?.result as string);

          if (importData.entries && Array.isArray(importData.entries)) {
            const confirmed = confirm(
              `${importData.entries.length}‰ª∂„ÅÆ„Ç®„É≥„Éà„É™„Éº„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô„ÄÇÁèæÂú®„ÅÆ„Éá„Éº„Çø„ÅØ‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÂÆüË°å„Åó„Åæ„Åô„ÅãÔºü`
            );

            if (confirmed) {
              this.entries = importData.entries;
              this.saveEntries();
              this.updateMoodFeatures();
              this.applyFilters();
              alert(
                `„Ç§„É≥„Éù„Éº„Éà„ÅåÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (${this.entries.length}‰ª∂„ÅÆ„Ç®„É≥„Éà„É™„Éº)`
              );
            }
          } else {
            alert('„Ç§„É≥„Éù„Éº„Éà„Éï„Ç°„Ç§„É´„ÅÆÂΩ¢Âºè„ÅåÊ≠£„Åó„Åè„ÅÇ„Çä„Åæ„Åõ„Çì');
          }
        } catch (error) {
          console.error('„Ç§„É≥„Éù„Éº„Éà„Ç®„É©„Éº:', error);
          alert('„Ç§„É≥„Éù„Éº„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
        }
      };
      reader.readAsText(file);
    });
    input.click();
  }

  private syncWithCloud() {
    alert(
      '„ÇØ„É©„Ç¶„ÉâÂêåÊúüÊ©üËÉΩ„ÅØÊ∫ñÂÇô‰∏≠„Åß„Åô„ÄÇÂ∞ÜÊù•ÁöÑ„Å´GoogleDrive„ÄÅDropboxÁ≠â„Å®„ÅÆÂêåÊúü„Çí‰∫àÂÆö„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ'
    );
  }

  private initializeFileInputs() {
    this.imageInput?.addEventListener('change', e => this.handleImageUpload(e));
    this.fileInput?.addEventListener('change', e => this.handleFileUpload(e));
  }

  private async handleImageUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const files = input.files;
    if (!files) return;

    for (const file of Array.from(files)) {
      if (!file.type.startsWith('image/')) {
        alert(`${file.name} „ÅØÁîªÂÉè„Éï„Ç°„Ç§„É´„Åß„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì`);
        continue;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert(`${file.name} „ÅØ5MB„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô`);
        continue;
      }

      try {
        const base64 = await this.fileToBase64(file);
        this.selectedImages.push(base64);
        this.updateFileDisplay();
      } catch (error) {
        console.error('ÁîªÂÉèË™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        alert(`${file.name} „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
      }
    }
    input.value = '';
  }

  private async handleFileUpload(event: Event) {
    const input = event.target as HTMLInputElement;
    const files = input.files;
    if (!files) return;

    for (const file of Array.from(files)) {
      if (file.size > 10 * 1024 * 1024) {
        alert(`${file.name} „ÅØ10MB„ÇíË∂Ö„Åà„Å¶„ÅÑ„Åæ„Åô`);
        continue;
      }

      try {
        const base64 = await this.fileToBase64(file);
        const attachment: FileAttachment = {
          id:
            Date.now().toString() + Math.random().toString(36).substring(2, 11),
          name: file.name,
          type: file.type,
          size: file.size,
          data: base64,
        };
        this.selectedAttachments.push(attachment);
        this.updateFileDisplay();
      } catch (error) {
        console.error('„Éï„Ç°„Ç§„É´Ë™≠„ÅøËæº„Åø„Ç®„É©„Éº:', error);
        alert(`${file.name} „ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü`);
      }
    }
    input.value = '';
  }

  private fileToBase64(file: File): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result as string);
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  private updateFileDisplay() {
    this.updateImagePreview();
    this.updateAttachmentList();
  }

  private updateImagePreview() {
    const container = document.getElementById('image-preview');
    if (!container) return;

    container.textContent = '';

    if (this.selectedImages.length === 0) {
      container.className = 'hidden';
      return;
    }

    container.className = 'mt-2 grid grid-cols-2 md:grid-cols-3 gap-2';

    this.selectedImages.forEach((imageData, index) => {
      const wrapper = document.createElement('div');
      wrapper.className = 'relative group';

      const img = document.createElement('img');
      img.src = imageData;
      img.className = 'w-full h-24 object-cover rounded border';
      img.alt = `ÁîªÂÉè ${index + 1}`;

      const removeBtn = document.createElement('button');
      removeBtn.className =
        'absolute top-1 right-1 bg-red-500 text-white w-6 h-6 rounded-full text-xs hover:bg-red-600 opacity-0 group-hover:opacity-100 transition-opacity';
      removeBtn.textContent = '√ó';
      removeBtn.addEventListener('click', () => this.removeImage(index));

      wrapper.appendChild(img);
      wrapper.appendChild(removeBtn);
      container.appendChild(wrapper);
    });
  }

  private updateAttachmentList() {
    const container = document.getElementById('attachment-list');
    if (!container) return;

    container.textContent = '';

    if (this.selectedAttachments.length === 0) {
      container.className = 'hidden';
      return;
    }

    container.className = 'mt-2 space-y-2';

    this.selectedAttachments.forEach((attachment, index) => {
      const div = document.createElement('div');
      div.className =
        'flex items-center justify-between p-2 bg-gray-50 rounded border';

      const info = document.createElement('div');
      info.className = 'flex-1';

      const name = document.createElement('div');
      name.className = 'text-sm font-medium text-gray-700';
      name.textContent = attachment.name;

      const meta = document.createElement('div');
      meta.className = 'text-xs text-gray-500';
      meta.textContent = `${(attachment.size / 1024).toFixed(1)}KB`;

      info.appendChild(name);
      info.appendChild(meta);

      const removeBtn = document.createElement('button');
      removeBtn.className = 'text-red-500 hover:text-red-700 text-sm px-2 py-1';
      removeBtn.textContent = 'ÂâäÈô§';
      removeBtn.addEventListener('click', () => this.removeAttachment(index));

      div.appendChild(info);
      div.appendChild(removeBtn);
      container.appendChild(div);
    });
  }

  private removeImage(index: number) {
    this.selectedImages.splice(index, 1);
    this.updateFileDisplay();
  }

  private removeAttachment(index: number) {
    this.selectedAttachments.splice(index, 1);
    this.updateFileDisplay();
  }

  private appendImagesDisplay(container: HTMLElement, images: string[]) {
    const imagesDiv = document.createElement('div');
    imagesDiv.className = 'mt-3';

    const labelDiv = document.createElement('div');
    labelDiv.className = 'text-sm font-medium text-gray-600 mb-2';
    labelDiv.textContent = 'üì∑ ÁîªÂÉè';

    const imageGrid = document.createElement('div');
    imageGrid.className = 'grid grid-cols-2 md:grid-cols-3 gap-2';

    images.forEach((imageData, index) => {
      const imageWrapper = document.createElement('div');
      imageWrapper.className = 'relative group cursor-pointer';

      const img = document.createElement('img');
      img.src = imageData;
      img.className =
        'w-full h-24 object-cover rounded border hover:shadow-md transition-shadow';
      img.alt = `ÁîªÂÉè ${index + 1}`;
      img.addEventListener('click', () => this.showImageModal(imageData));

      imageWrapper.appendChild(img);
      imageGrid.appendChild(imageWrapper);
    });

    imagesDiv.appendChild(labelDiv);
    imagesDiv.appendChild(imageGrid);
    container.appendChild(imagesDiv);
  }

  private appendAttachmentsDisplay(
    container: HTMLElement,
    attachments: FileAttachment[]
  ) {
    const attachmentsDiv = document.createElement('div');
    attachmentsDiv.className = 'mt-3';

    const labelDiv = document.createElement('div');
    labelDiv.className = 'text-sm font-medium text-gray-600 mb-2';
    labelDiv.textContent = 'üìé Ê∑ª‰ªò„Éï„Ç°„Ç§„É´';

    const attachmentsList = document.createElement('div');
    attachmentsList.className = 'space-y-1';

    attachments.forEach(attachment => {
      const attachmentDiv = document.createElement('div');
      attachmentDiv.className =
        'flex items-center justify-between p-2 bg-gray-50 rounded border hover:bg-gray-100 transition-colors';

      const infoDiv = document.createElement('div');
      infoDiv.className = 'flex-1';

      const nameSpan = document.createElement('span');
      nameSpan.className = 'text-sm font-medium text-gray-700';
      nameSpan.textContent = attachment.name;

      const metaSpan = document.createElement('span');
      metaSpan.className = 'text-xs text-gray-500 ml-2';
      metaSpan.textContent = `(${(attachment.size / 1024).toFixed(1)}KB)`;

      infoDiv.appendChild(nameSpan);
      infoDiv.appendChild(metaSpan);

      const downloadBtn = document.createElement('button');
      downloadBtn.className =
        'text-blue-500 hover:text-blue-700 text-sm px-2 py-1 rounded transition-colors';
      downloadBtn.textContent = '„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ';
      downloadBtn.addEventListener('click', () =>
        this.downloadAttachment(attachment)
      );

      attachmentDiv.appendChild(infoDiv);
      attachmentDiv.appendChild(downloadBtn);
      attachmentsList.appendChild(attachmentDiv);
    });

    attachmentsDiv.appendChild(labelDiv);
    attachmentsDiv.appendChild(attachmentsList);
    container.appendChild(attachmentsDiv);
  }

  private showImageModal(imageData: string) {
    const modal = document.createElement('div');
    modal.className =
      'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4';

    const img = document.createElement('img');
    img.src = imageData;
    img.className = 'max-w-full max-h-full object-contain';

    const closeBtn = document.createElement('button');
    closeBtn.className =
      'absolute top-4 right-4 text-white text-2xl bg-black bg-opacity-50 w-10 h-10 rounded-full hover:bg-opacity-75 transition-all';
    closeBtn.textContent = '√ó';
    closeBtn.addEventListener('click', () => document.body.removeChild(modal));

    modal.addEventListener('click', e => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });

    modal.appendChild(img);
    modal.appendChild(closeBtn);
    document.body.appendChild(modal);
  }

  private downloadAttachment(attachment: FileAttachment) {
    try {
      const link = document.createElement('a');
      link.href = attachment.data;
      link.download = attachment.name;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } catch (error) {
      console.error('„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Ç®„É©„Éº:', error);
      alert('„Éï„Ç°„Ç§„É´„ÅÆ„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü');
    }
  }

  private initializeExportFeatures() {
    const exportJsonBtn = document.getElementById('export-json');
    const exportPdfBtn = document.getElementById('export-pdf');
    const backupBtn = document.getElementById('backup-data');
    const restoreBtn = document.getElementById('restore-data');
    const importBtn = document.getElementById('import-data');
    const syncBtn = document.getElementById('sync-cloud');

    exportJsonBtn?.addEventListener('click', () => this.exportToJSON());
    exportPdfBtn?.addEventListener('click', () => this.exportToPDF());
    backupBtn?.addEventListener('click', () => this.backupData());
    restoreBtn?.addEventListener('click', () => this.restoreData());
    importBtn?.addEventListener('click', () => this.importFromFile());
    syncBtn?.addEventListener('click', () => this.syncWithCloud());
  }

  // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÊ©üËÉΩ„ÅÆÂÆüË£Ö
  private loadTemplates() {
    const stored = localStorage.getItem('diary-templates');
    if (stored) {
      try {
        const customTemplates = JSON.parse(stored);
        this.templates = [...this.presetTemplates, ...customTemplates];
      } catch (error) {
        console.error('Error parsing templates:', error);
        this.templates = [...this.presetTemplates];
      }
    } else {
      this.templates = [...this.presetTemplates];
    }
  }

  private saveTemplates() {
    const customTemplates = this.templates.filter(t => t.type === 'custom');
    localStorage.setItem('diary-templates', JSON.stringify(customTemplates));
  }

  private initializeTemplateFeatures() {
    this.populateTemplateSelector();

    this.templateSelector?.addEventListener('change', () => {
      this.applyTemplate();
    });

    this.saveTemplateButton?.addEventListener('click', () => {
      this.saveCurrentAsTemplate();
    });

    this.manageTemplatesButton?.addEventListener('click', () => {
      this.openTemplateManager();
    });
  }

  private populateTemplateSelector() {
    if (!this.templateSelector) return;

    // Êó¢Â≠ò„ÅÆ„Ç™„Éó„Ç∑„Éß„É≥„Çí„ÇØ„É™„Ç¢ÔºàÊúÄÂàù„ÅÆ„Éá„Éï„Ç©„É´„Éà„Ç™„Éó„Ç∑„Éß„É≥‰ª•Â§ñÔºâ
    while (this.templateSelector.children.length > 1) {
      this.templateSelector.removeChild(this.templateSelector.lastChild!);
    }

    // „Éó„É™„Çª„ÉÉ„Éà„ÉÜ„É≥„Éó„É¨„Éº„Éà
    const presetGroup = document.createElement('optgroup');
    presetGroup.label = '„Éó„É™„Çª„ÉÉ„Éà';

    this.templates
      .filter(t => t.type === 'preset')
      .forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        presetGroup.appendChild(option);
      });

    this.templateSelector.appendChild(presetGroup);

    // „Ç´„Çπ„Çø„É†„ÉÜ„É≥„Éó„É¨„Éº„Éà
    const customTemplates = this.templates.filter(t => t.type === 'custom');
    if (customTemplates.length > 0) {
      const customGroup = document.createElement('optgroup');
      customGroup.label = '„Ç´„Çπ„Çø„É†';

      customTemplates.forEach(template => {
        const option = document.createElement('option');
        option.value = template.id;
        option.textContent = template.name;
        customGroup.appendChild(option);
      });

      this.templateSelector.appendChild(customGroup);
    }
  }

  private applyTemplate() {
    const selectedId = this.templateSelector?.value;
    if (!selectedId) return;

    const template = this.templates.find(t => t.id === selectedId);
    if (!template) return;

    // ÁèæÂú®„ÅÆÂÜÖÂÆπ„Åå„ÅÇ„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    const hasContent =
      this.titleInput.value.trim() || this.contentInput.value.trim();
    if (hasContent) {
      const confirmed = confirm('ÁèæÂú®„ÅÆÂÜÖÂÆπ„Åå‰∏äÊõ∏„Åç„Åï„Çå„Åæ„Åô„ÄÇÁ∂öË°å„Åó„Åæ„Åô„ÅãÔºü');
      if (!confirmed) {
        this.templateSelector.value = '';
        return;
      }
    }

    // „ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÈÅ©Áî®
    let title = template.title;
    let content = template.content;

    // ÂãïÁöÑÂ§âÊï∞„ÇíÁΩÆÊèõ
    const now = new Date();
    const dateStr = now.toLocaleDateString('ja-JP', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    title = title.replace('{{DATE}}', dateStr);
    content = content.replace('{{DATE}}', dateStr);

    this.titleInput.value = title;
    this.contentInput.value = content;

    // „Éï„Ç©„Éº„Ç´„Çπ„ÇíÂÜÖÂÆπ„Ç®„É™„Ç¢„Å´ÁßªÂãï
    this.contentInput.focus();
    this.contentInput.setSelectionRange(
      this.contentInput.value.length,
      this.contentInput.value.length
    );
  }

  private saveCurrentAsTemplate() {
    const title = this.titleInput.value.trim();
    const content = this.contentInput.value.trim();

    if (!title || !content) {
      alert('„Çø„Ç§„Éà„É´„Å®ÂÜÖÂÆπ„ÇíÂÖ•Âäõ„Åó„Å¶„Åã„Çâ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Å®„Åó„Å¶‰øùÂ≠ò„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
      return;
    }

    const templateName = prompt('„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ:', title);
    if (!templateName) return;

    // ÂêåÂêç„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åô„Çã„Åã„ÉÅ„Çß„ÉÉ„ÇØ
    const existingTemplate = this.templates.find(
      t => t.name === templateName && t.type === 'custom'
    );
    if (existingTemplate) {
      const confirmed = confirm(
        'ÂêåÂêç„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ‰∏äÊõ∏„Åç„Åó„Åæ„Åô„ÅãÔºü'
      );
      if (!confirmed) return;

      // Êó¢Â≠ò„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞
      existingTemplate.title = title;
      existingTemplate.content = content;
      existingTemplate.createdAt = new Date().toISOString();
    } else {
      // Êñ∞„Åó„ÅÑ„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩúÊàê
      const newTemplate: DiaryTemplate = {
        id: Date.now().toString() + Math.random().toString(36).substring(2, 11),
        name: templateName,
        title: title,
        content: content,
        type: 'custom',
        createdAt: new Date().toISOString(),
      };
      this.templates.push(newTemplate);
    }

    this.saveTemplates();
    this.populateTemplateSelector();
    alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü„ÄÇ');
  }

  private openTemplateManager() {
    this.showTemplateManagerModal();
  }

  private showTemplateManagerModal() {
    const modal = document.createElement('div');
    modal.className =
      'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

    const modalContent = document.createElement('div');
    modalContent.className =
      'bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[80vh] overflow-hidden';

    const header = document.createElement('div');
    header.className = 'p-6 border-b border-gray-200';

    const headerTitle = document.createElement('h2');
    headerTitle.className = 'text-xl font-semibold text-gray-800';
    headerTitle.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁÆ°ÁêÜ';

    const closeBtn = document.createElement('button');
    closeBtn.className =
      'float-right text-gray-500 hover:text-gray-700 text-2xl leading-none';
    closeBtn.textContent = '√ó';
    closeBtn.addEventListener('click', () => document.body.removeChild(modal));

    header.appendChild(headerTitle);
    header.appendChild(closeBtn);

    const body = document.createElement('div');
    body.className = 'p-6 overflow-y-auto max-h-[60vh]';

    const customTemplates = this.templates.filter(t => t.type === 'custom');

    if (customTemplates.length === 0) {
      const emptyMsg = document.createElement('p');
      emptyMsg.className = 'text-gray-500 text-center py-8';
      emptyMsg.textContent = '„Ç´„Çπ„Çø„É†„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅØ„Åæ„Å†„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ';
      body.appendChild(emptyMsg);
    } else {
      customTemplates.forEach(template => {
        const templateDiv = document.createElement('div');
        templateDiv.className = 'border border-gray-200 rounded-lg p-4 mb-4';

        const templateHeader = document.createElement('div');
        templateHeader.className = 'flex justify-between items-start mb-2';

        const templateName = document.createElement('h3');
        templateName.className = 'font-medium text-gray-800';
        templateName.textContent = template.name;

        const templateActions = document.createElement('div');
        templateActions.className = 'flex gap-2';

        const editBtn = document.createElement('button');
        editBtn.className =
          'text-blue-500 hover:text-blue-700 text-sm px-2 py-1';
        editBtn.textContent = 'Á∑®ÈõÜ';
        editBtn.addEventListener('click', () =>
          this.editTemplate(template.id, modal)
        );

        const deleteBtn = document.createElement('button');
        deleteBtn.className =
          'text-red-500 hover:text-red-700 text-sm px-2 py-1';
        deleteBtn.textContent = 'ÂâäÈô§';
        deleteBtn.addEventListener('click', () =>
          this.deleteTemplate(template.id, modal)
        );

        templateActions.appendChild(editBtn);
        templateActions.appendChild(deleteBtn);

        templateHeader.appendChild(templateName);
        templateHeader.appendChild(templateActions);

        const templatePreview = document.createElement('div');
        templatePreview.className = 'text-sm text-gray-600';

        const titlePreview = document.createElement('div');
        titlePreview.className = 'font-medium mb-1';
        titlePreview.textContent = `„Çø„Ç§„Éà„É´: ${template.title}`;

        const contentPreview = document.createElement('div');
        contentPreview.className = 'whitespace-pre-wrap';
        contentPreview.textContent =
          template.content.length > 100
            ? template.content.substring(0, 100) + '...'
            : template.content;

        templatePreview.appendChild(titlePreview);
        templatePreview.appendChild(contentPreview);

        templateDiv.appendChild(templateHeader);
        templateDiv.appendChild(templatePreview);
        body.appendChild(templateDiv);
      });
    }

    modalContent.appendChild(header);
    modalContent.appendChild(body);
    modal.appendChild(modalContent);

    // „É¢„Éº„ÉÄ„É´Â§ñ„ÇØ„É™„ÉÉ„ÇØ„ÅßÈñâ„Åò„Çã
    modal.addEventListener('click', e => {
      if (e.target === modal) {
        document.body.removeChild(modal);
      }
    });

    document.body.appendChild(modal);
  }

  private editTemplate(templateId: string, parentModal: HTMLElement) {
    const template = this.templates.find(t => t.id === templateId);
    if (!template || template.type !== 'custom') return;

    document.body.removeChild(parentModal);

    const modal = document.createElement('div');
    modal.className =
      'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';

    const modalContent = document.createElement('div');
    modalContent.className = 'bg-white rounded-lg shadow-xl max-w-2xl w-full';

    const header = document.createElement('div');
    header.className = 'p-6 border-b border-gray-200';

    const headerTitle = document.createElement('h2');
    headerTitle.className = 'text-xl font-semibold text-gray-800';
    headerTitle.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÁ∑®ÈõÜ';

    header.appendChild(headerTitle);

    const body = document.createElement('div');
    body.className = 'p-6';

    const form = document.createElement('div');
    form.className = 'space-y-4';

    // „ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêçÂÖ•Âäõ
    const nameDiv = document.createElement('div');
    const nameLabel = document.createElement('label');
    nameLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
    nameLabel.textContent = '„ÉÜ„É≥„Éó„É¨„Éº„ÉàÂêç';

    const nameInput = document.createElement('input');
    nameInput.type = 'text';
    nameInput.className =
      'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent';
    nameInput.value = template.name;

    nameDiv.appendChild(nameLabel);
    nameDiv.appendChild(nameInput);

    // „Çø„Ç§„Éà„É´ÂÖ•Âäõ
    const titleDiv = document.createElement('div');
    const titleLabel = document.createElement('label');
    titleLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
    titleLabel.textContent = '„Çø„Ç§„Éà„É´';

    const titleInput = document.createElement('input');
    titleInput.type = 'text';
    titleInput.className =
      'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent';
    titleInput.value = template.title;

    titleDiv.appendChild(titleLabel);
    titleDiv.appendChild(titleInput);

    // ÂÜÖÂÆπÂÖ•Âäõ
    const contentDiv = document.createElement('div');
    const contentLabel = document.createElement('label');
    contentLabel.className = 'block text-sm font-medium text-gray-700 mb-1';
    contentLabel.textContent = 'ÂÜÖÂÆπ';

    const contentTextarea = document.createElement('textarea');
    contentTextarea.rows = 8;
    contentTextarea.className =
      'w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none';
    contentTextarea.value = template.content;

    contentDiv.appendChild(contentLabel);
    contentDiv.appendChild(contentTextarea);

    form.appendChild(nameDiv);
    form.appendChild(titleDiv);
    form.appendChild(contentDiv);

    // „Éú„Çø„É≥
    const buttonDiv = document.createElement('div');
    buttonDiv.className = 'flex justify-end gap-2 mt-6';

    const cancelBtn = document.createElement('button');
    cancelBtn.className =
      'px-4 py-2 text-gray-600 bg-gray-100 rounded-md hover:bg-gray-200 transition duration-200';
    cancelBtn.textContent = '„Ç≠„É£„É≥„Çª„É´';
    cancelBtn.addEventListener('click', () => {
      document.body.removeChild(modal);
      this.openTemplateManager();
    });

    const saveBtn = document.createElement('button');
    saveBtn.className =
      'px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition duration-200';
    saveBtn.textContent = '‰øùÂ≠ò';
    saveBtn.addEventListener('click', () => {
      const newName = nameInput.value.trim();
      const newTitle = titleInput.value.trim();
      const newContent = contentTextarea.value.trim();

      if (!newName || !newTitle || !newContent) {
        alert('„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ');
        return;
      }

      // ÂêåÂêç„ÉÅ„Çß„ÉÉ„ÇØÔºàËá™ÂàÜ‰ª•Â§ñ„ÅßÔºâ
      const existingTemplate = this.templates.find(
        t => t.name === newName && t.id !== templateId && t.type === 'custom'
      );
      if (existingTemplate) {
        alert('ÂêåÂêç„ÅÆ„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅåÊó¢„Å´Â≠òÂú®„Åó„Åæ„Åô„ÄÇ');
        return;
      }

      template.name = newName;
      template.title = newTitle;
      template.content = newContent;
      template.createdAt = new Date().toISOString();

      this.saveTemplates();
      this.populateTemplateSelector();

      document.body.removeChild(modal);
      this.openTemplateManager();
      alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü„ÄÇ');
    });

    buttonDiv.appendChild(cancelBtn);
    buttonDiv.appendChild(saveBtn);

    body.appendChild(form);
    body.appendChild(buttonDiv);

    modalContent.appendChild(header);
    modalContent.appendChild(body);
    modal.appendChild(modalContent);

    document.body.appendChild(modal);
  }

  private deleteTemplate(templateId: string, parentModal: HTMLElement) {
    const template = this.templates.find(t => t.id === templateId);
    if (!template || template.type !== 'custom') return;

    const confirmed = confirm(
      `„ÉÜ„É≥„Éó„É¨„Éº„Éà„Äå${template.name}„Äç„ÇíÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü`
    );
    if (!confirmed) return;

    this.templates = this.templates.filter(t => t.id !== templateId);
    this.saveTemplates();
    this.populateTemplateSelector();

    document.body.removeChild(parentModal);
    this.openTemplateManager();
    alert('„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÇíÂâäÈô§„Åó„Åæ„Åó„Åü„ÄÇ');
  }
}

new DiaryApp();
